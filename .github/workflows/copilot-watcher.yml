# Copilot Watcher â€” Event-Driven Completion Detection
#
# Triggers when "Copilot coding agent" workflow completes.
# Unlike pull_request events (which don't fire for Bot-created PRs),
# workflow_run is a platform-level event that DOES fire for any
# workflow completion â€” including Copilot agent runs.
#
# This workflow:
# 1. Analyzes what Copilot did (finds draft PR, linked issue)
# 2. Counts task progress (completed/total)
# 3. Dispatches to ZLsAI/Workflow when ready for testing
#
# Required secret: ORCHESTRATOR_PAT
#   (fine-grained PAT with Actions: write on ZLsAI/Workflow)

name: Copilot Watcher

on:
  workflow_run:
    workflows: ["Copilot coding agent"]
    types: [completed]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      branch:
        description: "Copilot branch to check (e.g., copilot/setup-backend)"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  detect-and-report:
    runs-on: ubuntu-latest
    steps:
      - name: Analyze Copilot completion
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            // â”€â”€ Determine trigger source â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const isWorkflowRun = context.eventName === 'workflow_run';
            const branch = isWorkflowRun
              ? context.payload.workflow_run.head_branch
              : '${{ inputs.branch }}'.trim() || null;
            const conclusion = isWorkflowRun
              ? context.payload.workflow_run.conclusion
              : 'success';
            const agentRunId = isWorkflowRun
              ? context.payload.workflow_run.id
              : 0;

            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('  Copilot Watcher â€” Completion Detection');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`Event:      ${context.eventName}`);
            console.log(`Branch:     ${branch || 'N/A'}`);
            console.log(`Conclusion: ${conclusion}`);
            console.log(`Agent Run:  ${agentRunId}`);

            if (!branch) {
              console.log('No branch to analyze, exiting.');
              core.setOutput('should_dispatch', 'false');
              return;
            }

            // Skip if Copilot agent failed
            if (conclusion !== 'success') {
              console.log(`Copilot agent ${conclusion}, skipping.`);
              core.setOutput('should_dispatch', 'false');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // â”€â”€ Find the draft PR for this branch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const prs = await github.rest.pulls.list({
              owner, repo,
              head: `${owner}:${branch}`,
              state: 'open',
              per_page: 5
            });

            const draftPr = prs.data.find(p => p.draft) || prs.data[0];
            if (!draftPr) {
              console.log(`No PR found for branch ${branch}`);
              core.setOutput('should_dispatch', 'false');
              return;
            }

            console.log(`\nDraft PR: #${draftPr.number} "${draftPr.title}"`);
            console.log(`  Draft: ${draftPr.draft}`);
            console.log(`  By:    ${draftPr.user.login}`);

            // â”€â”€ Extract linked issue from PR body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const prBody = draftPr.body || '';
            const issueMatch = prBody.match(
              /(?:fixes|closes|resolves)\s+#(\d+)/i
            );
            const linkedIssue = issueMatch ? parseInt(issueMatch[1]) : null;
            console.log(`  Issue: ${linkedIssue ? '#' + linkedIssue : 'none found'}`);

            // â”€â”€ Extract orchestrator metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const runIdMatch = prBody.match(
              /<!-- orchestrator-run-id:\s*(\d+)\s*-->/
            );
            const taskIdMatch = prBody.match(
              /<!-- task-id:\s*([\w-]+)\s*-->/
            );
            const orchestratorRunId = runIdMatch ? runIdMatch[1] : '';
            const taskId = taskIdMatch ? taskIdMatch[1] : '';

            // â”€â”€ Count task progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Total tasks = OPEN issues with 'copilot-task' label
            // IMPORTANT: state must be 'open' to only count current session
            const issues = await github.rest.issues.listForRepo({
              owner, repo,
              labels: 'copilot-task',
              state: 'open',
              per_page: 100
            });

            // Filter: exclude PRs (GitHub mixes them) AND exclude parent
            // group issues (title contains "Issue Group") which are just
            // organizational wrappers, not actual tasks for Copilot
            const taskIssues = issues.data.filter(i =>
              !i.pull_request &&
              !i.title.includes('Issue Group')
            );
            const totalTasks = taskIssues.length;

            console.log(`\nâ”â”â” Task Issues (${taskIssues.length} real tasks) â”â”â”`);
            taskIssues.forEach(i => console.log(`  #${i.number}: ${i.title}`));

            // Completed = Copilot draft PRs (each represents a finished task)
            const allPrs = await github.rest.pulls.list({
              owner, repo,
              state: 'open',
              per_page: 50
            });
            const copilotPrs = allPrs.data.filter(p =>
              p.user.login === 'Copilot' || p.user.type === 'Bot'
            );
            const completedTasks = copilotPrs.length;

            console.log(`\nâ”â”â” Copilot PRs (${copilotPrs.length} completed) â”â”â”`);
            copilotPrs.forEach(p => console.log(`  #${p.number}: ${p.head.ref}`));

            console.log(`\nâ”â”â” Progress â”â”â”`);
            console.log(`  Total tasks:  ${totalTasks} (from ${issues.data.length} issues, ${issues.data.filter(i => i.title.includes('Issue Group')).length} group issues filtered out)`);
            console.log(`  Completed:    ${completedTasks} / ${totalTasks}`);
            console.log(`  Branches:     ${copilotPrs.map(p => p.head.ref).join(', ')}`);

            const allDone = completedTasks >= totalTasks && totalTasks > 0;
            console.log(`  All done:  ${allDone}`);

            // â”€â”€ Collect branch info for dispatch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const branchData = copilotPrs.map(p => ({
              branch: p.head.ref,
              pr_number: p.number,
              title: p.title,
              draft: p.draft,
              sha: p.head.sha
            }));

            // â”€â”€ Store outputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            core.setOutput('should_dispatch', 'true');
            core.setOutput('all_done', String(allDone));
            core.setOutput('completed', String(completedTasks));
            core.setOutput('total', String(totalTasks));
            core.setOutput('current_branch', branch);
            core.setOutput('current_pr', String(draftPr.number));
            core.setOutput('linked_issue', String(linkedIssue || ''));
            core.setOutput('orchestrator_run_id', orchestratorRunId);
            core.setOutput('task_id', taskId);
            core.setOutput('branches_json', JSON.stringify(branchData));
            core.setOutput('source_repo', `${owner}/${repo}`);

      - name: Dispatch to orchestrator repo
        if: steps.analyze.outputs.should_dispatch == 'true'
        env:
          DISPATCH_TOKEN: ${{ secrets.ORCHESTRATOR_PAT }}
          ALL_DONE: ${{ steps.analyze.outputs.all_done }}
          COMPLETED: ${{ steps.analyze.outputs.completed }}
          TOTAL: ${{ steps.analyze.outputs.total }}
          SOURCE_REPO: ${{ steps.analyze.outputs.source_repo }}
          CURRENT_BRANCH: ${{ steps.analyze.outputs.current_branch }}
          CURRENT_PR: ${{ steps.analyze.outputs.current_pr }}
          LINKED_ISSUE: ${{ steps.analyze.outputs.linked_issue }}
          ORCH_RUN_ID: ${{ steps.analyze.outputs.orchestrator_run_id }}
          TASK_ID: ${{ steps.analyze.outputs.task_id }}
          BRANCHES_JSON: ${{ steps.analyze.outputs.branches_json }}
        uses: actions/github-script@v7
        with:
          script: |
            const allDone = process.env.ALL_DONE === 'true';
            const completed = process.env.COMPLETED;
            const total = process.env.TOTAL;

            console.log(`\nDispatching to ZLsAI/Workflow...`);
            console.log(`  Status: ${completed}/${total} tasks complete`);
            console.log(`  All done: ${allDone}`);

            // Only dispatch to task-runner when ALL tasks are complete
            // Individual completions are tracked but don't trigger testing
            if (!allDone) {
              console.log(`\nâ³ Waiting for remaining tasks (${completed}/${total})`);
              console.log('No dispatch needed yet. Will trigger when all tasks finish.');
              return;
            }

            console.log(`\nâœ… All ${total} tasks complete! Triggering test runner...`);

            // Dispatch to task-runner.yml in Workflow repo
            const resp = await fetch(
              'https://api.github.com/repos/ZLsAI/Workflow/actions/workflows/task-runner.yml/dispatches',
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.DISPATCH_TOKEN}`,
                  'Accept': 'application/vnd.github+json',
                  'X-GitHub-Api-Version': '2022-11-28'
                },
                body: JSON.stringify({
                  ref: 'main',
                  inputs: {
                    source_repo: process.env.SOURCE_REPO,
                    completed_count: completed,
                    total_count: total,
                    branches_json: process.env.BRANCHES_JSON
                  }
                })
              }
            );

            if (!resp.ok) {
              const err = await resp.text();
              core.setFailed(`Failed to dispatch: HTTP ${resp.status} â€” ${err}`);
            } else {
              console.log('âœ“ Dispatched task-runner workflow');
            }

      - name: Comment progress on linked issue
        if: |
          steps.analyze.outputs.should_dispatch == 'true' &&
          steps.analyze.outputs.linked_issue != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.analyze.outputs.linked_issue }}');
            const completed = '${{ steps.analyze.outputs.completed }}';
            const total = '${{ steps.analyze.outputs.total }}';
            const allDone = '${{ steps.analyze.outputs.all_done }}' === 'true';
            const branch = '${{ steps.analyze.outputs.current_branch }}';
            const pr = '${{ steps.analyze.outputs.current_pr }}';

            const icon = allDone ? 'âœ…' : 'ğŸ”„';
            const status = allDone
              ? 'All tasks complete â€” testing sequence starting'
              : `Task completed (${completed}/${total})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `## ${icon} ${status}`,
                '',
                `| Detail | Value |`,
                `|--------|-------|`,
                `| Branch | \`${branch}\` |`,
                `| Draft PR | #${pr} |`,
                `| Progress | **${completed} / ${total}** |`,
                '',
                allDone
                  ? 'â†’ Dispatched automated testing to [Workflow repo](https://github.com/ZLsAI/Workflow/actions)'
                  : 'â†’ Waiting for remaining tasks to complete',
                '',
                `<!-- copilot-watcher-progress: ${completed}/${total} -->`,
                `<!-- copilot-watcher-branch: ${branch} -->`
              ].join('\n')
            });
