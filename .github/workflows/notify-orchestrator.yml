# Notify Orchestrator - Cross-Repo Communication
#
# When Copilot (or any contributor) creates/updates/merges a PR,
# this workflow dispatches an event to ZLsAI/Workflow so the
# orchestrator can track progress, run tests, and continue the loop.
#
# Required secret: ORCHESTRATOR_PAT (fine-grained PAT with
#   actions:write on ZLsAI/Workflow for repository_dispatch)

name: Notify Orchestrator

on:
  pull_request:
    types: [opened, synchronize, closed, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  notify:
    runs-on: ubuntu-latest
    # Skip if PR was created by a bot re-trigger (avoid infinite loops)
    if: >-
      !contains(github.event.pull_request.labels.*.name, 'orchestrator-skip')
    steps:
      - name: Gather PR metadata
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const isMerged = pr.merged === true;
            const isCopilot = (pr.user?.login || '').toLowerCase().includes('copilot');
            const labels = pr.labels.map(l => l.name);
            const isAiTask = labels.some(l =>
              ['ai-orchestrated', 'copilot-task'].includes(l)
            );

            // Extract orchestrator run ID from PR body if present
            // Pattern: <!-- orchestrator-run-id: 12345 -->
            const runIdMatch = (pr.body || '').match(
              /<!-- orchestrator-run-id:\s*(\d+)\s*-->/
            );
            const orchestratorRunId = runIdMatch ? runIdMatch[1] : '';

            // Extract task ID from PR body if present
            // Pattern: <!-- task-id: aw_abc123 -->
            const taskIdMatch = (pr.body || '').match(
              /<!-- task-id:\s*(aw_\w+)\s*-->/
            );
            const taskId = taskIdMatch ? taskIdMatch[1] : '';

            core.setOutput('is_merged', isMerged.toString());
            core.setOutput('is_copilot', isCopilot.toString());
            core.setOutput('is_ai_task', isAiTask.toString());
            core.setOutput('orchestrator_run_id', orchestratorRunId);
            core.setOutput('task_id', taskId);
            core.setOutput('pr_number', pr.number.toString());
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_branch', pr.head.ref);
            core.setOutput('pr_sha', pr.head.sha);
            core.setOutput('base_branch', pr.base.ref);
            core.setOutput('pr_state', pr.state);
            core.setOutput('pr_action', context.payload.action);

      - name: Dispatch to Orchestrator
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORCHESTRATOR_PAT }}
          script: |
            const meta = {
              source_repo: '${{ github.repository }}',
              pr_number: parseInt('${{ steps.meta.outputs.pr_number }}'),
              pr_title: `${{ steps.meta.outputs.pr_title }}`,
              pr_branch: '${{ steps.meta.outputs.pr_branch }}',
              pr_sha: '${{ steps.meta.outputs.pr_sha }}',
              base_branch: '${{ steps.meta.outputs.base_branch }}',
              pr_state: '${{ steps.meta.outputs.pr_state }}',
              pr_action: '${{ steps.meta.outputs.pr_action }}',
              is_merged: '${{ steps.meta.outputs.is_merged }}' === 'true',
              is_copilot: '${{ steps.meta.outputs.is_copilot }}' === 'true',
              is_ai_task: '${{ steps.meta.outputs.is_ai_task }}' === 'true',
              orchestrator_run_id: '${{ steps.meta.outputs.orchestrator_run_id }}',
              task_id: '${{ steps.meta.outputs.task_id }}',
              timestamp: new Date().toISOString()
            };

            // Determine event type based on PR action
            let eventType = 'pr-opened';
            if (meta.pr_action === 'closed' && meta.is_merged) {
              eventType = 'pr-merged';
            } else if (meta.pr_action === 'closed') {
              eventType = 'pr-closed';
            } else if (meta.pr_action === 'synchronize') {
              eventType = 'pr-updated';
            } else if (meta.pr_action === 'ready_for_review') {
              eventType = 'pr-ready';
            }

            console.log(`Dispatching '${eventType}' to ZLsAI/Workflow`);
            console.log('Payload:', JSON.stringify(meta, null, 2));

            await github.rest.repos.createDispatchEvent({
              owner: 'ZLsAI',
              repo: 'Workflow',
              event_type: eventType,
              client_payload: meta
            });

            console.log('Dispatch sent successfully');
